{% extends "base.html" %}

{% block content %}
  <h2>
    {% if is_new %}
      Add Bundle
    {% else %}
      Edit Bundle: {{ cluster.code }}
    {% endif %}
  </h2>

  <form method="post">
    {% csrf_token %}

    <fieldset style="margin-bottom: 18px;">
      <legend>Bundle Details</legend>

      {% if form.non_field_errors %}
        <div style="color:#b00020; margin:8px 0;">{{ form.non_field_errors }}</div>
      {% endif %}

      <div style="margin:10px 0;">
        <label>Code:</label><br>
        {{ form.code }} {{ form.code.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Display name:</label><br>
        {{ form.display_name }} {{ form.display_name.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Description:</label><br>
        {{ form.description }} {{ form.description.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Trigger:</label><br>
        {{ form.trigger }} {{ form.trigger.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Is published:</label>
        {{ form.is_published }} {{ form.is_published.errors }}
      </div>

      <div style="margin:10px 0;">
        <label>Is active:</label>
        {{ form.is_active }} {{ form.is_active.errors }}
      </div>
    </fieldset>

    <fieldset style="margin-bottom: 18px;">
      <legend>Bundle Names (per language)</legend>

      {{ lang_fs.management_form }}

      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Language</th>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Name</th>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Delete?</th>
          </tr>
        </thead>
        <tbody>
          {% for f in lang_fs.forms %}
            <tr>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {{ f.language_code }}
                {{ f.language_code.errors }}
              </td>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {{ f.name }}
                {{ f.name.errors }}
              </td>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {% if f.DELETE %}{{ f.DELETE }}{% endif %}
              </td>
            </tr>
            {% if f.non_field_errors %}
              <tr>
                <td colspan="3" style="padding:8px; border:1px solid #e5e7eb; color:#b00020;">
                  {{ f.non_field_errors }}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </fieldset>

    <fieldset style="margin-bottom: 18px;">
      <legend>Videos in this Bundle</legend>

      {{ vid_fs.management_form }}

      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Video</th>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Sort order</th>
            <th style="text-align:left; padding:8px; border:1px solid #e5e7eb;">Delete?</th>
          </tr>
        </thead>
        <tbody>
          {% for f in vid_fs.forms %}
            <tr>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                <input type="text"
                       class="video-filter"
                       data-target="{{ f.video.id_for_label }}"
                       placeholder="Type to filter videos..."
                       style="width:100%; margin-bottom:8px; padding:8px; border:1px solid #d1d5db; border-radius:8px;">
                {{ f.video }}
                {{ f.video.errors }}
              </td>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {{ f.sort_order }}
                {{ f.sort_order.errors }}
              </td>
              <td style="padding:8px; border:1px solid #e5e7eb;">
                {% if f.DELETE %}{{ f.DELETE }}{% endif %}
              </td>
            </tr>
            {% if f.non_field_errors %}
              <tr>
                <td colspan="3" style="padding:8px; border:1px solid #e5e7eb; color:#b00020;">
                  {{ f.non_field_errors }}
                </td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>

      <div style="margin-top:10px; color:#6b7280; font-size:13px;">
        Tip: Start typing above a dropdown to filter its video options.
      </div>
    </fieldset>

    <button type="submit">Save</button>
    <a href="{% url 'publisher:cluster_list' %}" style="margin-left: 12px;">Back</a>
  </form>

  <script>
  (function() {
    // Build an option cache per select
    const selectCache = new Map();

    function cacheSelect(selectEl) {
      if (!selectEl || selectCache.has(selectEl)) return;
      const opts = Array.from(selectEl.options).map(o => ({ value: o.value, text: o.text }));
      selectCache.set(selectEl, opts);
    }

    function applyFilter(selectEl, query) {
      cacheSelect(selectEl);
      const all = selectCache.get(selectEl) || [];
      const q = (query || "").toLowerCase().trim();

      const current = selectEl.value;

      const filtered = q
        ? all.filter(o => (o.text || "").toLowerCase().includes(q))
        : all;

      // Rebuild options
      selectEl.innerHTML = "";
      filtered.forEach(o => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.text;
        selectEl.appendChild(opt);
      });

      // Restore selection if still present
      if (filtered.some(o => o.value === current)) {
        selectEl.value = current;
      } else {
        // If current is not present, keep first option selected
        selectEl.selectedIndex = 0;
      }
    }

    // Hook all video selects
    document.querySelectorAll("select.video-select").forEach(cacheSelect);

    // Connect filter inputs
    document.querySelectorAll("input.video-filter").forEach(inp => {
      const targetId = inp.getAttribute("data-target");
      const selectEl = targetId ? document.getElementById(targetId) : null;
      if (!selectEl) return;

      cacheSelect(selectEl);

      inp.addEventListener("input", () => {
        applyFilter(selectEl, inp.value);
      });
    });
  })();
  </script>
{% endblock %}
