{% extends "base.html" %}

{% block content %}
  <h2>
    {% if is_new %}
      New Bundle
    {% else %}
      Edit Bundle: {{ cluster.code }}
    {% endif %}
  </h2>

  <form method="post">
    {% csrf_token %}

    <fieldset style="margin-bottom: 18px;">
      <legend>Bundle Details</legend>
      {{ form.as_p }}
    </fieldset>

    <fieldset style="margin-bottom: 18px;">
      <legend>Bundle Names (per language)</legend>

      {{ lang_fs.management_form }}

      <table border="1" cellpadding="8" cellspacing="0" style="width: 100%;">
        <tr>
          <th>Language</th>
          <th>Name</th>
          <th>Delete?</th>
        </tr>

        {% for f in lang_fs.forms %}
          <tr>
            <td>
              {# REQUIRED: hidden inline form fields (id, etc.) #}
              {% for h in f.hidden_fields %}
                {{ h }}
              {% endfor %}

              {{ f.language_code }}

              {% if f.language_code.errors %}
                <div style="color: #b00020; font-size: 12px;">
                  {{ f.language_code.errors }}
                </div>
              {% endif %}
            </td>

            <td>
              {{ f.name }}

              {% if f.name.errors %}
                <div style="color: #b00020; font-size: 12px;">
                  {{ f.name.errors }}
                </div>
              {% endif %}
            </td>

            <td>
              {{ f.DELETE }}
            </td>
          </tr>

          {% if f.non_field_errors %}
            <tr>
              <td colspan="3">
                <div style="color: #b00020; font-size: 12px;">
                  {{ f.non_field_errors }}
                </div>
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </table>
    </fieldset>

    <fieldset style="margin-bottom: 18px;">
      <legend>Videos in this Bundle</legend>

      {{ vid_fs.management_form }}

      <table border="1" cellpadding="8" cellspacing="0" style="width: 100%;">
        <tr>
          <th>Video</th>
          <th>Sort Order</th>
          <th>Delete?</th>
        </tr>

        {% for f in vid_fs.forms %}
          <tr>
            <td>
              {# REQUIRED: hidden inline form fields (id, etc.) #}
              {% for h in f.hidden_fields %}
                {{ h }}
              {% endfor %}

              <input type="text" class="video-filter" data-target-id="{{ f.video.id_for_label }}" placeholder="Type to filter videosâ€¦" style="width: 100%; margin-bottom: 6px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 8px;">
              {{ f.video }}

              {% if f.video.errors %}
                <div style="color: #b00020; font-size: 12px;">
                  {{ f.video.errors }}
                </div>
              {% endif %}
            </td>

            <td>
              {{ f.sort_order }}

              {% if f.sort_order.errors %}
                <div style="color: #b00020; font-size: 12px;">
                  {{ f.sort_order.errors }}
                </div>
              {% endif %}
            </td>

            <td>
              {{ f.DELETE }}
            </td>
          </tr>

          {% if f.non_field_errors %}
            <tr>
              <td colspan="3">
                <div style="color: #b00020; font-size: 12px;">
                  {{ f.non_field_errors }}
                </div>
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </table>
    </fieldset>

    <button type="submit">Save</button>
    <a href="{% url 'publisher:cluster_list' %}" style="margin-left: 12px;">
      Back
    </a>
  </form>
<script>
(function () {
  function setupFilter(input) {
    const targetId = input.getAttribute("data-target-id");
    if (!targetId) return;

    const select = document.getElementById(targetId);
    if (!select) return;

    // Capture original options once.
    const originalOptions = Array.from(select.options).map(o => ({
      value: o.value,
      text: o.text,
    }));

    function applyFilter() {
      const q = (input.value || "").toLowerCase().trim();
      const currentVal = select.value;

      // Rebuild options to avoid browser-specific quirks with option.hidden.
      select.innerHTML = "";
      originalOptions.forEach(o => {
        const match = !q || (o.text || "").toLowerCase().includes(q) || o.value === currentVal;
        if (!match) return;

        const opt = document.createElement("option");
        opt.value = o.value;
        opt.text = o.text;
        if (o.value === currentVal) opt.selected = true;
        select.appendChild(opt);
      });
    }

    input.addEventListener("input", applyFilter);
  }

  document.querySelectorAll(".video-filter").forEach(setupFilter);
})();
</script>

{% endblock %}

