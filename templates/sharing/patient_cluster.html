{% extends "base.html" %}
{% block title %}{{ clinic.display_name }} ‚Äî {{ cluster_title }}{% endblock %}
{% block header_title %}{{ clinic.display_name }}{% endblock %}

{% block content %}

<style>
  /* Language-specific font stacks for the few translated label strings on patient pages */
  .i18n-text.i18n-hi, .i18n-text.i18n-mr { font-family: "Noto Sans Devanagari", "Mangal", "Kohinoor Devanagari", sans-serif; }
  .i18n-text.i18n-bn { font-family: "Noto Sans Bengali", "Nirmala UI", "Lohit Bengali", sans-serif; }
  .i18n-text.i18n-ta { font-family: "Noto Sans Tamil", "Nirmala UI", "Lohit Tamil", sans-serif; }
  .i18n-text.i18n-te { font-family: "Noto Sans Telugu", "Nirmala UI", "Lohit Telugu", sans-serif; }
  .i18n-text.i18n-kn { font-family: "Noto Sans Kannada", "Nirmala UI", "Lohit Kannada", sans-serif; }
  .i18n-text.i18n-ml { font-family: "Noto Sans Malayalam", "Nirmala UI", "Lohit Malayalam", sans-serif; }
</style>

<div class="card">
  <div style="display: flex; align-items: flex-start; gap: 20px; flex-wrap: wrap; padding-bottom: 24px; border-bottom: 1px solid var(--border);">
    <div style="width: 80px; height: 80px; border-radius: 20px; border: 2px solid var(--border); background: linear-gradient(135deg, var(--primary), #3b82f6); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 800; position: relative; overflow: hidden; flex-shrink: 0;">
      <div style="line-height: 1;">{{ doctor.user.full_name|default:"D"|slice:":1"|upper }}</div>
      {% if doctor.photo %}
        <img src="{{ doctor.photo.url }}"
             alt="Doctor photo"
             loading="lazy"
             onerror="this.remove();"
             style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;" />
      {% endif %}
    </div>

    <div style="flex: 1; min-width: 0;">
      <div style="font-size: 1.5rem; font-weight: 800; color: var(--text); margin-bottom: 4px;">Dr. {{ doctor.user.full_name }}</div>
      <div class="muted" style="font-size: 0.9375rem; margin-bottom: 8px;">{{ clinic.display_name }}</div>
      <div class="muted" style="font-size: 0.875rem; margin-bottom: 4px;">{{ clinic.state }}{% if clinic.postal_code %} ‚Äî {{ clinic.postal_code }}{% endif %}</div>

      <div class="muted" style="margin-top: 12px; font-size: 0.875rem; line-height: 1.5;">
        {{ clinic.address_text|linebreaksbr }}
      </div>

      <div class="muted" style="margin-top: 8px; font-size: 0.875rem;">
        <div style="display: inline-flex; align-items: center; gap: 6px;">
          <span style="font-size: 1rem;">üìû</span>
            <span class="i18n-text i18n-{{ selected_lang }}">{{ ui.clinic_phone }}</span> {{ clinic.clinic_phone }}
        </div>
        {% if clinic.clinic_whatsapp_number %}
          <div style="display: inline-flex; align-items: center; gap: 6px; margin-left: 16px;">
            <span style="font-size: 1rem;">üí¨</span>
            <span class="i18n-text i18n-{{ selected_lang }}">{{ ui.whatsapp }}</span> {{ clinic.clinic_whatsapp_number }}
          </div>
        {% endif %}
      </div>
      <div class="muted" style="margin-top: 10px; font-size: 0.875rem;"><span class="i18n-text i18n-{{ selected_lang }}">{{ ui.educational_content }}</span></div>
    </div>
  </div>

  <div style="margin-top: 24px;">
    <div style="text-align: center; margin-bottom: 32px;">
      <div style="font-size: 2rem; font-weight: 800; color: var(--text); margin-bottom: 8px; line-height: 1.2;">{{ cluster_title }}</div>
      <div class="muted" style="font-size: 1.125rem; margin-bottom: 8px;">Patient education bundle</div>
      <div class="muted" style="font-size: 0.875rem;">
        {% if items %}
          {{ items|length }} video{{ items|length|pluralize:"s" }} in this collection
        {% else %}
          No videos in this bundle
        {% endif %}
      </div>
    </div>

    <div style="margin-bottom: 24px;">
      <div class="row" style="max-width: 300px;">
        <div>
          <label for="lang" style="font-size: 0.875rem; font-weight: 600; color: var(--text); margin-bottom: 8px; display: block;">Language</label>
          <select id="lang" style="width: 100%; padding: 12px; border: 1.5px solid var(--border-strong); border-radius: var(--radius-sm); background: var(--surface); color: var(--text); font-size: 0.9375rem;">
            {% for code, name in languages %}
              <option value="{{ code }}" {% if code == selected_lang %}selected{% endif %}>
                {{ name }}
              </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    {% if items %}
      {% for it in items %}
        <div style="margin-top: 32px; border-top: 1px solid var(--border); padding-top: 24px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; flex-shrink: 0;">
              {{ forloop.counter }}
            </div>
            <div style="font-size: 1.125rem; font-weight: 700; color: var(--text);">{{ it.title }}</div>
          </div>
          
          {% if it.url %}
            <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 16px; border: 1px solid var(--border); background: #000; box-shadow: var(--shadow-sm);">
              <iframe class="yt-player"
                      data-youtube-url="{{ it.url }}"
                      referrerpolicy="strict-origin-when-cross-origin"
                      loading="lazy"
                      style="position: absolute; top:0; left:0; width:100%; height:100%; border:0;"
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                      allowfullscreen></iframe>

              <div class="yt-fallback"
                   style="display:none; position: absolute; top:0; left:0; width:100%; height:100%; align-items:center; justify-content:center; flex-direction: column; gap: 16px; padding: 24px; background: var(--surface-2); text-align: center;">
                <div style="font-size: 48px; opacity: 0.5;">üé¨</div>
                <div class="muted" style="margin-bottom: 16px;">Unable to embed this video.</div>
                <a href="{{ it.url }}" target="_blank" rel="noopener noreferrer" style="padding: 12px 20px; background: var(--primary); color: #fff; border-radius: var(--radius-sm); font-weight: 600; text-decoration: none; font-size: 0.9375rem;">
                  Open on YouTube
                </a>
              </div>
            </div>
          {% else %}
            <div style="padding: 32px 24px; background: var(--surface-2); border-radius: 16px; text-align: center; margin-top: 16px;">
              <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">‚è≥</div>
              <div style="font-size: 1.125rem; font-weight: 600; color: var(--text); margin-bottom: 8px;">Video Coming Soon</div>
              <div class="muted">This educational video will be available shortly.</div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <div style="margin-top: 48px; padding: 48px 24px; background: var(--surface-2); border-radius: 16px; text-align: center; border: 2px dashed var(--border);">
        <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.5; color: var(--muted);">üì≠</div>
        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 12px;">No Videos Available</div>
        <div class="muted" style="max-width: 400px; margin: 0 auto;">
          This educational bundle is currently being prepared. Please check back soon for video content.
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
(function () {
  function toEmbedSrc(videoId) {
    const params = new URLSearchParams({
      rel: "0",
      modestbranding: "1",
      iv_load_policy: "3",
      playsinline: "1",
      disablekb: "1",
      controls: "1",
      fs: "1",
      origin: window.location.origin
    });
    return "https://www.youtube-nocookie.com/embed/" + videoId + "?" + params.toString();
  }

  document.querySelectorAll(".yt-player").forEach(function (iframe) {
    const rawUrl = iframe.dataset.youtubeUrl || "";
    const fallback = iframe.nextElementSibling;

    const match = rawUrl.match(
      /(?:youtube\.com\/watch\?v=|youtube\.com\/embed\/|youtube-nocookie\.com\/embed\/|youtu\.be\/)([A-Za-z0-9_-]{11})/
    );

    if (!match) {
      iframe.style.display = "none";
      if (fallback) fallback.style.display = "flex";
      return;
    }

    iframe.src = toEmbedSrc(match[1]);

    iframe.addEventListener("error", () => {
      iframe.style.display = "none";
      if (fallback) fallback.style.display = "flex";
    });
  });

  document.getElementById("lang").addEventListener("change", function () {
    const url = new URL(window.location.href);
    url.searchParams.set("lang", this.value);
    window.location.href = url.toString();
  });
})();
</script>
{% endblock %}

