{% extends "base.html" %}
{% block title %}{{ doctor.clinic.display_name }} ‚Äî Share Patient Education{% endblock %}
{% block header_title %}{{ doctor.clinic.display_name }}{% endblock %}

{% block head %}
<style>
  /* Enhanced sharing interface */
  .profile-row {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    padding: 20px 0;
  }

  .profile-photo {
    width: 100px;
    height: 100px;
    border-radius: 20px;
    object-fit: cover;
    border: 2px solid var(--border);
    background: var(--surface);
    box-shadow: var(--shadow-sm);
  }

  .avatar {
    width: 100px;
    height: 100px;
    border-radius: 20px;
    border: 2px solid var(--border);
    background: linear-gradient(135deg, var(--primary), #3b82f6);
    color: var(--primary-contrast);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: 900;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
    box-shadow: var(--shadow-md);
  }

  .avatar-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-letter {
    line-height: 1;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .profile-info {
    flex: 1;
    min-width: 250px;
  }

  .profile-name {
    font-size: 1.5rem;
    font-weight: 800;
    margin-bottom: 4px;
    color: var(--text);
  }

  .profile-subtitle {
    color: var(--muted);
    margin-bottom: 8px;
    font-size: 0.9375rem;
  }

  .kv-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .kv-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: var(--surface-2);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }

  .kv-label {
    font-weight: 600;
    color: var(--text);
    min-width: 140px;
    font-size: 0.875rem;
  }

  .kv-value {
    color: var(--muted);
    flex: 1;
    font-size: 0.9375rem;
  }

  .section-title {
    font-size: 1.25rem;
    margin: 0 0 20px 0;
    color: var(--text);
    position: relative;
    padding-bottom: 12px;
  }

  .section-title:after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), transparent);
    border-radius: 3px;
  }

  /* Filter Controls */
  .filter-grid {
    display: grid;
    gap: 20px;
    margin: 24px 0;
  }

  @media (min-width: 768px) {
    .filter-grid.three-col {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 767px) {
    .filter-grid.three-col {
      grid-template-columns: 1fr;
    }
  }

  .search-wrapper {
    position: relative;
    margin: 16px 0;
    width: 100%;
  }

  /* Ensure FULL-WIDTH search input on desktop + mobile */
  .search-wrapper input {
    width: 100%;
    box-sizing: border-box;
    padding-left: 44px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 12px center;
    background-size: 20px;
  }

  /* Toolbar: now search-only, always full width */
  .toolbar {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
    align-items: end;
    margin: 24px 0;
    width: 100%;
  }
  .toolbar .grow {
    width: 100%;
    min-width: 100%;
  }

  /* Video List */
  .video-list-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin: 20px 0;
    max-height: 400px;
    box-shadow: var(--shadow-sm);
  }

  .video-list {
    overflow-y: auto;
    max-height: 360px;
  }

  .video-item {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .video-item:last-child {
    border-bottom: none;
  }

  .video-item:hover {
    background: var(--surface-2);
    transform: translateX(4px);
  }

  .video-item.active {
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.1), transparent);
    border-left: 4px solid var(--primary);
    border-right: 1px solid var(--border);
  }

  .video-title {
    font-weight: 600;
    color: var(--text);
    flex: 1;
    font-size: 0.9375rem;
  }

  .video-icon {
    width: 32px;
    height: 32px;
    background: var(--surface-2);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    flex-shrink: 0;
  }

  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Share Actions */
  .share-section {
    background: var(--surface-2);
    border-radius: var(--radius-lg);
    padding: 24px;
    margin: 32px 0;
    border: 1px solid var(--border);
  }

  .input-group {
    position: relative;
    margin-bottom: 16px;
  }

  .input-group input {
    padding-left: 48px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 12px center;
    background-size: 20px;
  }

  .hint {
    color: var(--muted);
    font-size: 0.8125rem;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .hint:before {
    content: '‚ÑπÔ∏è';
    font-size: 0.75rem;
  }

  .context-hint {
    background: linear-gradient(90deg, var(--surface-2), transparent);
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    margin: 16px 0;
    border-left: 4px solid var(--primary);
    font-size: 0.875rem;
  }

  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
  }

  @media (max-width: 480px) {
    .actions-grid {
      grid-template-columns: 1fr;
    }
  }

  .action-card {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .action-card:hover {
    border-color: var(--primary);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .action-card.active {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), transparent);
  }

  .action-icon {
    font-size: 32px;
    margin-bottom: 12px;
    color: var(--primary);
  }

  .action-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text);
  }

  .action-description {
    color: var(--muted);
    font-size: 0.8125rem;
    line-height: 1.4;
  }

  .prominent-footer {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    text-align: center;
  }
    /* --- Campaign support acknowledgements & banners (system_pe) --- */
  .campaign-support {
    margin-top: 28px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }

  .campaign-support .ack-line {
    color: var(--muted);
    font-size: 0.9rem;
    margin: 6px 0;
    line-height: 1.35;
  }

  .campaign-support .banner-list {
    margin-top: 14px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .campaign-support .banner-link {
    display: block;
    text-decoration: none;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--surface);
    transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
  }

  .campaign-support .banner-link:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-md);
    transform: translateY(-1px);
  }

  .campaign-support .banner-link img {
    width: 100%;
    height: auto;
    display: block;
  }
    /* If banner has no link, keep it visible but non-clickable */
  .campaign-support .banner-link.banner-static {
    cursor: default;
  }
  .campaign-support .banner-link.banner-static:hover {
    border-color: var(--border);
    box-shadow: none;
    transform: none;
  }


  /* Mobile Optimizations */
  @media (max-width: 640px) {
    .profile-row {
      flex-direction: column;
      text-align: center;
      gap: 16px;
    }

    .avatar {
      width: 80px;
      height: 80px;
      font-size: 28px;
    }

    .kv-item {
      flex-direction: column;
      gap: 4px;
      text-align: center;
    }

    .kv-label {
      min-width: auto;
      font-size: 0.8125rem;
    }

    .section-title {
      font-size: 1.125rem;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-2: #334155;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --border: #475569;
    }

    .card,
    .video-list-container,
    .share-section {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
  }

  /* --- Bundle-grouped results --- */
  .bundle-group {
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--surface);
    margin-bottom: 14px;
  }

  .bundle-group.active {
    border-color: var(--primary);
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
  }

  .bundle-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 14px;
    background: var(--surface-2);
  }

  .bundle-title {
    font-weight: 700;
    color: var(--text);
    line-height: 1.2;
  }

  .bundle-meta {
    font-size: 0.8rem;
    color: var(--muted);
    margin-top: 4px;
  }

  .bundle-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  .bundle-actions .btn {
    padding: 8px 12px;
    font-size: 0.85rem;
  }

  .bundle-videos {
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .video-item.child {
    padding: 10px 12px;
  }

  .video-item.child .video-icon {
    width: 32px;
    height: 32px;
    font-size: 0.9rem;
  }

  /* NEW: per-video action button in grouped view */
  .video-actions {
    margin-left: auto;
    flex-shrink: 0;
  }
  .video-actions .btn {
    padding: 8px 12px;
    font-size: 0.85rem;
    white-space: nowrap;
  }
</style>
{% endblock %}

{% block content %}
<div class="card">
  <h3 class="section-title">Doctor Profile</h3>

  <div class="profile-row">
    <div class="avatar" aria-label="Doctor photo">
      <div class="avatar-letter">
        {{ doctor.user.full_name|default:"D"|slice:":1"|upper }}
      </div>
      {% if doctor.photo %}
        <img
          class="avatar-img"
          src="{{ doctor.photo.url }}"
          alt="Doctor photo"
          loading="lazy"
          onerror="this.remove();"
        />
      {% endif %}
    </div>

    <div class="profile-info">
      <div class="profile-name">Dr. {{ doctor.user.full_name }}</div>
      <div class="profile-subtitle">{{ doctor.clinic.display_name }}</div>
      <div class="muted">Doctor ID: {{ doctor.doctor_id }}</div>
    </div>
  </div>

  <div class="kv-grid">
    <div class="kv-item">
      <div class="kv-label">Doctor WhatsApp</div>
      <div class="kv-value">{{ doctor.whatsapp_number }}</div>
    </div>

    <div class="kv-item">
      <div class="kv-label">IMC / Reg.</div>
      <div class="kv-value">{{ doctor.imc_number }}</div>
    </div>

    <div class="kv-item">
      <div class="kv-label">Clinic Phone</div>
      <div class="kv-value">{{ doctor.clinic.clinic_phone }}</div>
    </div>

    {% if doctor.clinic.clinic_whatsapp_number %}
      <div class="kv-item">
        <div class="kv-label">Clinic WhatsApp</div>
        <div class="kv-value">
          {{ doctor.clinic.clinic_whatsapp_number }}
        </div>
      </div>
    {% endif %}
  </div>

  <div
    class="muted"
    style="margin-top: 16px; padding: 16px; background: var(--surface-2); border-radius: var(--radius-sm);"
  >
    <strong>Address:</strong><br />
    {{ doctor.clinic.address_text|linebreaksbr }}<br />
    {{ doctor.clinic.state }}
    {% if doctor.clinic.postal_code %}
      ‚Äî {{ doctor.clinic.postal_code }}
    {% endif %}
  </div>
</div>

<div class="card">
  <h3 class="section-title">Share Patient Education</h3>

  <div class="filter-grid three-col">
    <div class="form-group">
      <label for="therapySel">Therapy Area</label>
      <select id="therapySel"></select>
    </div>

    <div class="form-group">
      <label for="triggerSel">Trigger</label>
      <select id="triggerSel"></select>
    </div>

    <div class="form-group">
      <label for="bundleSel">Bundle</label>
      <select id="bundleSel"></select>
    </div>
  </div>

  {# Search bar full-width (language selector moved below into Share section) #}
  <div class="toolbar">
    <div class="grow">
      <label for="searchBox">Search Bundles / Videos</label>
      <div class="search-wrapper">
        <input
          id="searchBox"
          type="text"
          placeholder="Search by title, keyword, trigger, bundle name‚Ä¶"
          autocomplete="off"
        />
      </div>
    </div>
  </div>

  <div id="contextHint" class="context-hint"></div>

  <div class="video-list-container">
    <div id="videoList" class="video-list"></div>

    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-state-icon">üìπ</div>
      <p>No bundles/videos found for the current filters.</p>
      <p class="muted">Try adjusting your search or filters</p>
    </div>
  </div>

  <div class="share-section">
    <h4 style="margin-bottom: 20px; color: var(--text);">
      Share with Patient
    </h4>

    <div class="input-group">
      <label for="waNumber">Patient WhatsApp Number</label>
      <input
        id="waNumber"
        type="tel"
        maxlength="10"
        placeholder="Enter 10-digit WhatsApp number"
        inputmode="numeric"
      />
      <div class="hint">
        Enter the patient's 10-digit WhatsApp number (India).
      </div>
    </div>

    {# Language dropdown moved here (between the above hint line and the Tip block below) #}
    <div class="form-group" style="margin-top: 14px;">
      <label for="lang">Language</label>
      <select id="lang">
        {% for code, name in languages %}
          <option value="{{ code }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="actions-grid">
      <div class="action-card" id="videoCard" style="display: none;">
        <div class="action-icon">üé¨</div>
        <div class="action-title">Share Single Video</div>
        <div class="action-description">
          Share only the selected video
        </div>
        <button
          class="btn"
          id="shareVideoBtn"
          style="margin-top: 12px; width: 100%;"
        >
          Share Video
        </button>
      </div>

      <div class="action-card" id="bundleCard" style="display: none;">
        <div class="action-icon">üì¶</div>
        <div class="action-title">Share Complete Bundle</div>
        <div class="action-description">
          Share all videos in this bundle
        </div>
        <button
          class="btn"
          id="shareBundleBtn"
          style="margin-top: 12px; width: 100%;"
        >
          Share Bundle
        </button>
      </div>
    </div>

    <div class="hint" style="margin-top: 20px; text-align: center;">
      <strong>Tip:</strong>
      Select a bundle to list its videos. Click a video to share only that
      video.
    </div>
  </div>

  {# Campaign acknowledgements + banners #}
  {% if pe_campaign_support %}
    <div class="campaign-support">
      {% for c in pe_campaign_support %}
        <div class="ack-line">
          {{ c.video_cluster }} for your clinic is supported by {{ c.brand }}
        </div>
      {% endfor %}

      <div class="banner-list">
        {% for c in pe_campaign_support %}
          {% if c.banner_large_url or c.banner_small_url %}
            {% if c.banner_target_url %}
              <a
                class="banner-link"
                href="{{ c.banner_target_url }}"
                target="_blank"
                rel="noopener noreferrer"
              >
                <picture>
                  {% if c.banner_small_url %}
                    <source
                      media="(max-width: 640px)"
                      srcset="{{ c.banner_small_url }}"
                    />
                  {% endif %}

                  {% if c.banner_large_url %}
                    <img
                      src="{{ c.banner_large_url }}"
                      alt="{{ c.brand }} banner"
                      loading="lazy"
                    />
                  {% else %}
                    <img
                      src="{{ c.banner_small_url }}"
                      alt="{{ c.brand }} banner"
                      loading="lazy"
                    />
                  {% endif %}
                </picture>
              </a>
            {% else %}
              <div class="banner-link banner-static">
                <picture>
                  {% if c.banner_small_url %}
                    <source
                      media="(max-width: 640px)"
                      srcset="{{ c.banner_small_url }}"
                    />
                  {% endif %}

                  {% if c.banner_large_url %}
                    <img
                      src="{{ c.banner_large_url }}"
                      alt="{{ c.brand }} banner"
                      loading="lazy"
                    />
                  {% else %}
                    <img
                      src="{{ c.banner_small_url }}"
                      alt="{{ c.brand }} banner"
                      loading="lazy"
                    />
                  {% endif %}
                </picture>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if show_modify_clinic_details %}
    <div class="prominent-footer">
      <a
        class="btn btn-secondary"
        href="{% url 'accounts:modify_clinic_details' doctor_id=doctor.doctor_id %}"
        style="width: 100%; max-width: 300px;"
      >
        Modify Clinic Details
      </a>
    </div>
  {% endif %}
</div>



{{ catalog_json|json_script:"catalog-json" }}


<script>
const catalog = JSON.parse(document.getElementById("catalog-json").textContent);

const therapySel = document.getElementById("therapySel");
const triggerSel = document.getElementById("triggerSel");
const bundleSel = document.getElementById("bundleSel");
const searchBox = document.getElementById("searchBox");
const langSel = document.getElementById("lang");

const videoList = document.getElementById("videoList");
const contextHint = document.getElementById("contextHint");
const emptyState = document.getElementById("emptyState");

const waNumber = document.getElementById("waNumber");
const shareVideoBtn = document.getElementById("shareVideoBtn");
const shareBundleBtn = document.getElementById("shareBundleBtn");
const videoCard = document.getElementById("videoCard");
const bundleCard = document.getElementById("bundleCard");

let activeVideo = null;

// -------------------- helpers --------------------
function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function validWA() {
  return /^\d{10}$/.test((waNumber.value || "").trim());
}

const triggerByCode = {};
(catalog.triggers || []).forEach(t => { triggerByCode[t.code] = t; });

const bundleByCode = {};
(catalog.bundles || []).forEach(b => { bundleByCode[b.code] = b; });

const videoByCode = {};
(catalog.videos || []).forEach(v => { videoByCode[v.id] = v; });

const therapyByCode = {};
(catalog.therapy_areas || []).forEach(t => { therapyByCode[t.code] = t; });

function therapyLabel(code) {
  const t = therapyByCode[code];
  return (t && (t.display_name || t.code)) ? (t.display_name || t.code).trim() : (code || "");
}

function safeLower(s) {
  return String(s || "").toLowerCase();
}

function bundleLabel(b, lang) {
  if (!b) return "";
  const names = b.names || {};
  return (names[lang] || names["en"] || b.display_name || b.code || "").trim();
}

function bundleLabelByCode(code, lang) {
  return bundleLabel(bundleByCode[code], lang) || code;
}

function triggerLabelByCode(code) {
  const t = triggerByCode[code];
  return (t && (t.display_name || t.code)) ? (t.display_name || t.code).trim() : (code || "");
}

function videoTitle(v, lang) {
  if (!v) return "";
  const titles = v.titles || {};
  return (titles[lang] || titles["en"] || v.display_name || v.id || "").trim();
}

function populateSelect(el, items, labelFn, opts={}) {
  const includeAll = opts.includeAll !== false;  // default true
  const allLabel = opts.allLabel || "-- All --";
  const preserve = !!opts.preserve;
  const current = preserve ? (el.value || "") : "";

  el.innerHTML = "";

  if (includeAll) {
    const allOpt = document.createElement("option");
    allOpt.value = "";
    allOpt.textContent = allLabel;
    el.appendChild(allOpt);
  }

  (items || []).forEach(i => {
    const o = document.createElement("option");
    o.value = i.code;
    o.textContent = (labelFn(i) || i.code || "").trim();
    el.appendChild(o);
  });

  if (preserve && current) {
    el.value = current;
  }
}

function getSelectedTherapy() {
  return (therapySel.value || "").trim();
}

function getSelectedTrigger() {
  return (triggerSel.value || "").trim();
}

function getSelectedBundle() {
  return (bundleSel.value || "").trim();
}

function repopulateTriggers({preserve=false}={}) {
  const therapy = getSelectedTherapy();
  const triggers = (catalog.triggers || []).filter(t => {
    if (!therapy) return true;
    return (t.therapy_code || "") === therapy;
  });

  // Alphabetical by label (display_name)
  triggers.sort((a, b) => String(a.display_name || a.code || "").localeCompare(String(b.display_name || b.code || "")));

  populateSelect(triggerSel, triggers, t => t.display_name || t.code, {preserve, includeAll: true, allLabel: "-- All Triggers --"});
}

function repopulateBundles({preserve=false}={}) {
  const lang = langSel.value;
  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();

  const bundles = (catalog.bundles || []).filter(b => {
    if (therapy && (b.therapy_code || "") !== therapy) return false;
    if (trigger && (b.trigger_code || "") !== trigger) return false;
    return true;
  });

  // Alphabetical by localized label
  bundles.sort((a, b) => bundleLabel(a, lang).localeCompare(bundleLabel(b, lang)));

  populateSelect(bundleSel, bundles, b => bundleLabel(b, lang), {preserve, includeAll: true, allLabel: "-- All Bundles --"});
}

function clearVideoSelection() {
  activeVideo = null;
}

function currentFilteredVideos() {
  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();
  const bundle = getSelectedBundle();

  // If bundle selected: show all videos in that bundle
  if (bundle) {
    const b = bundleByCode[bundle];
    const codes = (b && Array.isArray(b.video_codes)) ? b.video_codes : [];
    const vids = codes.map(c => videoByCode[c]).filter(Boolean);
    return vids;
  }

  // Else filter by therapy/trigger using derived codes on videos
  return (catalog.videos || []).filter(v => {
    if (therapy && (!Array.isArray(v.therapy_codes) || !v.therapy_codes.includes(therapy))) return false;
    if (trigger && (!Array.isArray(v.trigger_codes) || !v.trigger_codes.includes(trigger))) return false;
    return true;
  });
}

function renderVideoFlat() {
  const lang = langSel.value;
  const vids = currentFilteredVideos();

  // Alphabetical by localized title
  vids.sort((a, b) => videoTitle(a, lang).localeCompare(videoTitle(b, lang)));

  // If the selected video is no longer in the list, clear it
  if (activeVideo && !vids.some(v => v.id === activeVideo.id)) {
    activeVideo = null;
  }

  videoList.innerHTML = "";

  if (!vids.length) {
    videoList.style.display = "none";
    emptyState.style.display = "block";
    return;
  }

  videoList.style.display = "block";
  emptyState.style.display = "none";

  vids.forEach(v => {
    const d = document.createElement("div");
    d.className = "video-item" + (activeVideo && activeVideo.id === v.id ? " active" : "");

    const title = videoTitle(v, lang) || v.id;

    d.innerHTML = `
      <div class="video-icon">‚ñ∂Ô∏è</div>
      <div class="video-title">${escapeHtml(title)}</div>
      <div style="font-size: 0.75rem; color: var(--muted); white-space: nowrap;">
        ${(v.bundle_codes && v.bundle_codes.length) || 0} bundle(s)
      </div>
    `;

    d.onclick = () => {
      // Toggle selection
      if (activeVideo && activeVideo.id === v.id) {
        activeVideo = null;
      } else {
        activeVideo = v;
      }
      updateButtons();
      render();
    };

    videoList.appendChild(d);
  });
}

/*
  UPDATED: This function now also supports q = "" (no keyword),
  so it can be used for dropdown-driven selection (therapy/trigger/bundle).
*/
function renderBundleGroupedSearch(q) {
  const lang = langSel.value;
  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();
  const selectedBundle = getSelectedBundle();

  const ql = safeLower(q).trim();
  const hasQuery = ql.length > 0;

  // Candidate bundles based on filters
  let candidates = (catalog.bundles || []).filter(b => {
    if (therapy && (b.therapy_code || "") !== therapy) return false;
    if (trigger && (b.trigger_code || "") !== trigger) return false;
    return true;
  });

  if (selectedBundle) {
    const b = bundleByCode[selectedBundle];
    candidates = b ? [b] : [];
  }

  const results = [];
  for (const b of candidates) {
    const vCodes = Array.isArray(b.video_codes) ? b.video_codes : [];
    const vidsAll = vCodes.map(c => videoByCode[c]).filter(Boolean);

    // If no query: show bundle with all videos (dropdown mode)
    if (!hasQuery) {
      if (vidsAll.length) {
        vidsAll.sort((a, bb) => videoTitle(a, lang).localeCompare(videoTitle(bb, lang)));
      }
      results.push({
        bundle: b,
        bundleMatches: true,
        videos: vidsAll,
        allVideoCount: vidsAll.length,
      });
      continue;
    }

    // With query: show bundles that match name OR contain matching videos
    const bSearch = safeLower(b.search_text || "") + " " + safeLower(bundleLabel(b, lang));
    const bundleMatches = bSearch.includes(ql);

    const vidsMatching = vidsAll.filter(v => safeLower(v.search_text || "").includes(ql));

    if (bundleMatches || vidsMatching.length) {
      const vidsToShow = bundleMatches ? vidsAll : vidsMatching;
      vidsToShow.sort((a, bb) => videoTitle(a, lang).localeCompare(videoTitle(bb, lang)));

      results.push({
        bundle: b,
        bundleMatches,
        videos: vidsToShow,
        allVideoCount: vidsAll.length,
      });
    }
  }

  results.sort((a, b) => bundleLabel(a.bundle, lang).localeCompare(bundleLabel(b.bundle, lang)));

  // Standalone videos only for query mode (prevents huge noise when q == "")
  const standalone = (!hasQuery) ? [] : (catalog.videos || []).filter(v => {
    const hasBundles = Array.isArray(v.bundle_codes) && v.bundle_codes.length;
    if (hasBundles) return false;
    return safeLower(v.search_text || "").includes(ql);
  });

  if (standalone.length) {
    standalone.sort((a, b) => videoTitle(a, lang).localeCompare(videoTitle(b, lang)));
  }

  // Validate activeVideo still present
  if (activeVideo) {
    const stillThereInBundles = results.some(r => r.videos.some(v => v.id === activeVideo.id));
    const stillThereStandalone = standalone.some(v => v.id === activeVideo.id);
    if (!stillThereInBundles && !stillThereStandalone) activeVideo = null;
  }

  videoList.innerHTML = "";

  if (!results.length && !standalone.length) {
    videoList.style.display = "none";
    emptyState.style.display = "block";
    return;
  }

  videoList.style.display = "block";
  emptyState.style.display = "none";

  // Helper to align filters to a specific bundle and optionally select a video
  function alignToBundle(b, bCode) {
    bundleSel.value = bCode;

    if (b.therapy_code) therapySel.value = b.therapy_code;
    repopulateTriggers({preserve: true});
    if (b.trigger_code) triggerSel.value = b.trigger_code;
    repopulateBundles({preserve: true});
    bundleSel.value = bCode;
  }

  results.forEach(r => {
    const b = r.bundle;
    const bCode = b.code;
    const bTitle = bundleLabel(b, lang) || bCode;

    const group = document.createElement("div");
    group.className = "bundle-group" + (!activeVideo && getSelectedBundle() === bCode ? " active" : "");

    const header = document.createElement("div");
    header.className = "bundle-header";
    header.innerHTML = `
      <div>
        <div class="bundle-title">${escapeHtml(bTitle)}</div>
        <div class="bundle-meta">
          Trigger: ${escapeHtml(triggerLabelByCode(b.trigger_code || ""))}${b.therapy_code ? " ¬∑ Therapy: " + escapeHtml(therapyLabel(b.therapy_code)) : ""} ¬∑ ${r.allVideoCount} video(s)
        </div>
      </div>
      <div class="bundle-actions">
        <button type="button" class="btn btn-secondary" data-action="select-bundle" data-bundle="${escapeHtml(bCode)}">Select bundle</button>
      </div>
    `;

    header.querySelector("button[data-action='select-bundle']").onclick = () => {
      clearVideoSelection();
      alignToBundle(b, bCode);
      updateButtons();
      render();
    };

    const body = document.createElement("div");
    body.className = "bundle-videos";

    r.videos.forEach(v => {
      const d = document.createElement("div");
      d.className = "video-item child" + (activeVideo && activeVideo.id === v.id ? " active" : "");
      const title = videoTitle(v, lang) || v.id;

      // UPDATED: add Select video button
      d.innerHTML = `
        <div class="video-icon">‚ñ∂Ô∏è</div>
        <div class="video-title">${escapeHtml(title)}</div>
        <div class="video-actions">
          <button type="button"
                  class="btn btn-secondary"
                  data-action="select-video"
                  data-bundle="${escapeHtml(bCode)}"
                  data-video="${escapeHtml(v.id)}">
            Select video
          </button>
        </div>
      `;

      // Clicking row also selects video (kept)
      d.onclick = (e) => {
        // If user clicked the button, let button handler run
        if (e && e.target && e.target.closest && e.target.closest("button[data-action='select-video']")) return;

        if (activeVideo && activeVideo.id === v.id) {
          activeVideo = null;
        } else {
          activeVideo = v;
          alignToBundle(b, bCode);
        }
        updateButtons();
        render();
      };

      // Button handler: always select video
      const btn = d.querySelector("button[data-action='select-video']");
      btn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();

        activeVideo = v;
        alignToBundle(b, bCode);

        updateButtons();
        render();
      };

      body.appendChild(d);
    });

    group.appendChild(header);
    group.appendChild(body);
    videoList.appendChild(group);
  });

  if (standalone.length) {
    const group = document.createElement("div");
    group.className = "bundle-group";

    const header = document.createElement("div");
    header.className = "bundle-header";
    header.innerHTML = `
      <div>
        <div class="bundle-title">Standalone Videos</div>
        <div class="bundle-meta">These videos are not currently part of any bundle/cluster.</div>
      </div>
    `;
    group.appendChild(header);

    const body = document.createElement("div");
    body.className = "bundle-videos";

    standalone.forEach(v => {
      const d = document.createElement("div");
      d.className = "video-item child" + (activeVideo && activeVideo.id === v.id ? " active" : "");
      const title = videoTitle(v, lang) || v.id;
      d.innerHTML = `
        <div class="video-icon">‚ñ∂Ô∏è</div>
        <div class="video-title">${escapeHtml(title)}</div>
        <div class="video-actions">
          <button type="button" class="btn btn-secondary">Select video</button>
        </div>
      `;

      d.onclick = (e) => {
        if (e && e.target && e.target.closest && e.target.closest("button")) return;
        if (activeVideo && activeVideo.id === v.id) activeVideo = null;
        else activeVideo = v;
        bundleSel.value = "";
        updateButtons();
        render();
      };

      d.querySelector("button").onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        activeVideo = v;
        bundleSel.value = "";
        updateButtons();
        render();
      };

      body.appendChild(d);
    });

    group.appendChild(body);
    videoList.appendChild(group);
  }
}

/*
  UPDATED: render mode:
  - If keyword exists OR any dropdown filter selected (therapy/trigger/bundle): show grouped bundle cards
  - Else: show flat video browsing (original behavior)
*/
function render() {
  const q = (searchBox.value || "").trim();
  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();
  const bundle = getSelectedBundle();

  const hasDropdownFilters = !!(therapy || trigger || bundle);

  if (q || hasDropdownFilters) {
    renderBundleGroupedSearch(q);
  } else {
    renderVideoFlat();
  }
}

function updateContextHint() {
  const lang = langSel.value;
  const bundle = getSelectedBundle();

  if (activeVideo) {
    const t = videoTitle(activeVideo, lang) || activeVideo.id;
    contextHint.textContent = `Selected video: ${t}`;
    return;
  }

  if (bundle) {
    const b = bundleByCode[bundle];
    const bName = bundleLabelByCode(bundle, lang) || bundle;
    const count = (b && Array.isArray(b.video_codes)) ? b.video_codes.length : 0;
    contextHint.textContent = `Bundle selected: ${bName} (${count} video${count === 1 ? "" : "s"}).`;
    return;
  }

  const therapy = getSelectedTherapy();
  const trigger = getSelectedTrigger();
  if (therapy || trigger) {
    const parts = [];
    if (therapy) parts.push(`Therapy: ${therapyLabel(therapy)}`);
    if (trigger) parts.push(`Trigger: ${triggerLabelByCode(trigger) || trigger}`);
    contextHint.textContent = `Browsing by ${parts.join(" ¬∑ ")}`;
    return;
  }

  contextHint.textContent = "Browse bundles/videos using filters above";
}

function updateButtons() {
  const waOk = validWA();
  const bundle = getSelectedBundle();

  if (activeVideo) {
    videoCard.style.display = "block";
    bundleCard.style.display = "none";
    shareVideoBtn.disabled = !waOk;
  } else if (bundle) {
    videoCard.style.display = "none";
    bundleCard.style.display = "block";
    shareBundleBtn.disabled = !waOk;
  } else {
    videoCard.style.display = "none";
    bundleCard.style.display = "none";
  }

  updateContextHint();
}

function buildMessage(title, link, lang) {
  const prefix = (catalog.message_prefixes && catalog.message_prefixes[lang]) || "";
  const p = (prefix || "").trim();
  const t = (title || "").trim();
  let msg = "";
  if (p) msg += p + "\n\n";
  if (t) msg += t + "\n";
  msg += link;
  return msg;
}

function shareToWhatsApp(message) {
  const num = (waNumber.value || "").trim();
  if (!/^\d{10}$/.test(num)) return;
  window.open(`https://wa.me/91${num}?text=${encodeURIComponent(message)}`);
}

// -------------------- actions --------------------
shareVideoBtn.onclick = () => {
  if (!activeVideo) return;
  const lang = langSel.value;
  const title = videoTitle(activeVideo, lang) || activeVideo.id;
  const payload = catalog.doctor_payload ? `&d=${encodeURIComponent(catalog.doctor_payload)}` : "";
  const link = `${location.origin}/p/${catalog.doctor_id}/v/${activeVideo.id}/?lang=${lang}${payload}`;
  shareToWhatsApp(buildMessage(title, link, lang));
};

shareBundleBtn.onclick = () => {
  const bundle = getSelectedBundle();
  if (!bundle) return;
  const lang = langSel.value;
  const title = bundleLabelByCode(bundle, lang) || bundle;
  const payload = catalog.doctor_payload ? `&d=${encodeURIComponent(catalog.doctor_payload)}` : "";
  const link = `${location.origin}/p/${catalog.doctor_id}/c/${bundle}/?lang=${lang}${payload}`;
  shareToWhatsApp(buildMessage(title, link, lang));
};

// -------------------- event wiring --------------------
therapySel.addEventListener("change", () => {
  clearVideoSelection();

  repopulateTriggers({preserve: false});
  triggerSel.value = "";
  repopulateBundles({preserve: false});
  bundleSel.value = "";

  render();
  updateButtons();
});

triggerSel.addEventListener("change", () => {
  clearVideoSelection();

  repopulateBundles({preserve: false});
  bundleSel.value = "";

  render();
  updateButtons();
});

bundleSel.addEventListener("change", () => {
  clearVideoSelection();

  const bcode = getSelectedBundle();
  if (bcode) {
    const b = bundleByCode[bcode];
    if (b) {
      if (b.therapy_code) therapySel.value = b.therapy_code;
      repopulateTriggers({preserve: true});
      if (b.trigger_code) triggerSel.value = b.trigger_code;
      repopulateBundles({preserve: true});
      bundleSel.value = bcode;
    }
  }

  render();
  updateButtons();
});

langSel.addEventListener("change", () => {
  repopulateBundles({preserve: true});
  render();
  updateButtons();
});

searchBox.addEventListener("input", () => {
  clearVideoSelection();
  render();
  updateButtons();
});

waNumber.addEventListener("input", () => {
  updateButtons();
});

// -------------------- init --------------------
const therapiesSorted = (catalog.therapy_areas || []).slice().sort((a, b) => String(a.display_name || a.code || "").localeCompare(String(b.display_name || b.code || "")));
populateSelect(therapySel, therapiesSorted, t => t.display_name || t.code, {includeAll: true, allLabel: "-- All Therapies --"});
repopulateTriggers({preserve: false});
repopulateBundles({preserve: false});

render();
updateButtons();
</script>
{% endblock %}
