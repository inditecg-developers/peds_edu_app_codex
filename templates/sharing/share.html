{% extends "base.html" %}
{% block title %}{{ doctor.clinic.display_name }} ‚Äî Share Patient Education{% endblock %}
{% block header_title %}{{ doctor.clinic.display_name }}{% endblock %}

{% block head %}
<style>
  /* Enhanced sharing interface */
  .profile-row {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
    padding: 20px 0;
  }

  .profile-photo {
    width: 100px;
    height: 100px;
    border-radius: 20px;
    object-fit: cover;
    border: 2px solid var(--border);
    background: var(--surface);
    box-shadow: var(--shadow-sm);
  }

  .avatar {
    width: 100px;
    height: 100px;
    border-radius: 20px;
    border: 2px solid var(--border);
    background: linear-gradient(135deg, var(--primary), #3b82f6);
    color: var(--primary-contrast);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: 900;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
    box-shadow: var(--shadow-md);
  }

  .avatar-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .avatar-letter { 
    line-height: 1; 
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .profile-info {
    flex: 1;
    min-width: 250px;
  }

  .profile-name {
    font-size: 1.5rem;
    font-weight: 800;
    margin-bottom: 4px;
    color: var(--text);
  }

  .profile-subtitle {
    color: var(--muted);
    margin-bottom: 8px;
    font-size: 0.9375rem;
  }

  .kv-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .kv-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px;
    background: var(--surface-2);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
  }

  .kv-label {
    font-weight: 600;
    color: var(--text);
    min-width: 140px;
    font-size: 0.875rem;
  }

  .kv-value {
    color: var(--muted);
    flex: 1;
    font-size: 0.9375rem;
  }

  .section-title {
    font-size: 1.25rem;
    margin: 0 0 20px 0;
    color: var(--text);
    position: relative;
    padding-bottom: 12px;
  }

  .section-title:after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), transparent);
    border-radius: 3px;
  }

  /* Filter Controls */
  .filter-grid {
    display: grid;
    gap: 20px;
    margin: 24px 0;
  }

  @media (min-width: 768px) {
    .filter-grid.three-col {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 767px) {
    .filter-grid.three-col {
      grid-template-columns: 1fr;
    }
  }

  .search-wrapper {
    position: relative;
    margin: 16px 0;
  }

  .search-wrapper input {
    padding-left: 44px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 12px center;
    background-size: 20px;
  }

  .toolbar {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 20px;
    align-items: end;
    margin: 24px 0;
  }

  @media (max-width: 640px) {
    .toolbar {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .toolbar .grow {
      min-width: 100%;
    }
  }

  /* Video List */
  .video-list-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin: 20px 0;
    max-height: 400px;
    box-shadow: var(--shadow-sm);
  }

  .video-list {
    overflow-y: auto;
    max-height: 360px;
  }

  .video-item {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .video-item:last-child {
    border-bottom: none;
  }

  .video-item:hover {
    background: var(--surface-2);
    transform: translateX(4px);
  }

  .video-item.active {
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.1), transparent);
    border-left: 4px solid var(--primary);
    border-right: 1px solid var(--border);
  }

  .video-title {
    font-weight: 600;
    color: var(--text);
    flex: 1;
    font-size: 0.9375rem;
  }

  .video-icon {
    width: 32px;
    height: 32px;
    background: var(--surface-2);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    flex-shrink: 0;
  }

  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--muted);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
  }

  /* Share Actions */
  .share-section {
    background: var(--surface-2);
    border-radius: var(--radius-lg);
    padding: 24px;
    margin: 32px 0;
    border: 1px solid var(--border);
  }

  .input-group {
    position: relative;
    margin-bottom: 16px;
  }

  .input-group input {
    padding-left: 48px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 12px center;
    background-size: 20px;
  }

  .hint {
    color: var(--muted);
    font-size: 0.8125rem;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .hint:before {
    content: '‚ÑπÔ∏è';
    font-size: 0.75rem;
  }

  .context-hint {
    background: linear-gradient(90deg, var(--surface-2), transparent);
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    margin: 16px 0;
    border-left: 4px solid var(--primary);
    font-size: 0.875rem;
  }

  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
  }

  @media (max-width: 480px) {
    .actions-grid {
      grid-template-columns: 1fr;
    }
  }

  .action-card {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .action-card:hover {
    border-color: var(--primary);
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .action-card.active {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), transparent);
  }

  .action-icon {
    font-size: 32px;
    margin-bottom: 12px;
    color: var(--primary);
  }

  .action-title {
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text);
  }

  .action-description {
    color: var(--muted);
    font-size: 0.8125rem;
    line-height: 1.4;
  }

  .prominent-footer {
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    text-align: center;
  }

  /* Mobile Optimizations */
  @media (max-width: 640px) {
    .profile-row {
      flex-direction: column;
      text-align: center;
      gap: 16px;
    }
    
    .avatar {
      width: 80px;
      height: 80px;
      font-size: 28px;
    }
    
    .kv-item {
      flex-direction: column;
      gap: 4px;
      text-align: center;
    }
    
    .kv-label {
      min-width: auto;
      font-size: 0.8125rem;
    }
    
    .section-title {
      font-size: 1.125rem;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-2: #334155;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --border: #475569;
    }
    
    .card,
    .video-list-container,
    .share-section {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="card">
  <h3 class="section-title">Doctor Profile</h3>

  <div class="profile-row">
    <div class="avatar" aria-label="Doctor photo">
      <div class="avatar-letter">{{ doctor.user.full_name|default:"D"|slice:":1"|upper }}</div>
      {% if doctor.photo %}
        <img class="avatar-img" src="{{ doctor.photo.url }}" alt="Doctor photo" loading="lazy" onerror="this.remove();" />
      {% endif %}
    </div>
    <div class="profile-info">
      <div class="profile-name">Dr. {{ doctor.user.full_name }}</div>
      <div class="profile-subtitle">{{ doctor.clinic.display_name }}</div>
      <div class="muted">Doctor ID: {{ doctor.doctor_id }}</div>
    </div>
  </div>

  <div class="kv-grid">
    <div class="kv-item">
      <div class="kv-label">Doctor WhatsApp</div>
      <div class="kv-value">{{ doctor.whatsapp_number }}</div>
    </div>
    <div class="kv-item">
      <div class="kv-label">IMC / Reg.</div>
      <div class="kv-value">{{ doctor.imc_number }}</div>
    </div>
    <div class="kv-item">
      <div class="kv-label">Clinic Phone</div>
      <div class="kv-value">{{ doctor.clinic.clinic_phone }}</div>
    </div>
    {% if doctor.clinic.clinic_whatsapp_number %}
    <div class="kv-item">
      <div class="kv-label">Clinic WhatsApp</div>
      <div class="kv-value">{{ doctor.clinic.clinic_whatsapp_number }}</div>
    </div>
    {% endif %}
  </div>

  <div class="muted" style="margin-top: 16px; padding: 16px; background: var(--surface-2); border-radius: var(--radius-sm);">
    <strong>Address:</strong><br>
    {{ doctor.clinic.address_text|linebreaksbr }}<br>
    {{ doctor.clinic.state }}{% if doctor.clinic.postal_code %} ‚Äî {{ doctor.clinic.postal_code }}{% endif %}
  </div>
</div>

<div class="card">
  <h3 class="section-title">Share Patient Education</h3>

  <div class="filter-grid three-col">
    <div class="form-group">
      <label for="therapySel">Therapy Area</label>
      <select id="therapySel"></select>
    </div>

    <div class="form-group">
      <label for="topicSel">Topic</label>
      <select id="topicSel"></select>
    </div>

    <div class="form-group">
      <label for="bundleSel">Bundle</label>
      <select id="bundleSel"></select>
    </div>
  </div>

  <div class="toolbar">
    <div class="grow">
      <label for="searchBox">Search Videos</label>
      <div class="search-wrapper">
        <input id="searchBox" type="text" placeholder="Search by title, keyword, bundle name‚Ä¶" autocomplete="off" />
      </div>
    </div>

    <div style="min-width: 220px;">
      <label for="lang">Language</label>
      <select id="lang">
        {% for code, name in languages %}
          <option value="{{ code }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div id="contextHint" class="context-hint"></div>

  <div class="video-list-container">
    <div id="videoList" class="video-list"></div>
    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-state-icon">üìπ</div>
      <p>No videos found for the current filters.</p>
      <p class="muted">Try adjusting your search or filters</p>
    </div>
  </div>

  <div class="share-section">
    <h4 style="margin-bottom: 20px; color: var(--text);">Share with Patient</h4>
    
    <div class="input-group">
      <label for="waNumber">Patient WhatsApp Number</label>
      <input id="waNumber" type="tel" maxlength="10" placeholder="Enter 10-digit WhatsApp number" inputmode="numeric" />
      <div class="hint">Enter the patient's 10-digit WhatsApp number (India).</div>
    </div>

    <div class="actions-grid">
      <div class="action-card" id="videoCard" style="display: none;">
        <div class="action-icon">üé¨</div>
        <div class="action-title">Share Single Video</div>
        <div class="action-description">Share only the selected video</div>
        <button class="btn" id="shareVideoBtn" style="margin-top: 12px; width: 100%;">Share Video</button>
      </div>

      <div class="action-card" id="bundleCard" style="display: none;">
        <div class="action-icon">üì¶</div>
        <div class="action-title">Share Complete Bundle</div>
        <div class="action-description">Share all videos in this bundle</div>
        <button class="btn" id="shareBundleBtn" style="margin-top: 12px; width: 100%;">Share Bundle</button>
      </div>
    </div>

    <div class="hint" style="margin-top: 20px; text-align: center;">
      <strong>Tip:</strong> Select a bundle to list its videos. Click a video to share only that video.
    </div>
  </div>

  <div class="prominent-footer">
    <a class="btn btn-secondary" href="{% url 'accounts:modify_clinic_details' doctor_id=doctor.doctor_id %}" style="width: 100%; max-width: 300px;">
      Modify Clinic Details
    </a>
  </div>
</div>

{{ catalog_json|json_script:"catalog-json" }}

<script>
// Existing JavaScript remains completely unchanged - only CSS updates
const catalog = JSON.parse(document.getElementById("catalog-json").textContent);

const therapySel = document.getElementById("therapySel");
const topicSel = document.getElementById("topicSel");
const bundleSel = document.getElementById("bundleSel");
const searchBox = document.getElementById("searchBox");
const langSel = document.getElementById("lang");

const videoList = document.getElementById("videoList");
const contextHint = document.getElementById("contextHint");
const emptyState = document.getElementById("emptyState");

const waNumber = document.getElementById("waNumber");
const shareVideoBtn = document.getElementById("shareVideoBtn");
const shareBundleBtn = document.getElementById("shareBundleBtn");
const videoCard = document.getElementById("videoCard");
const bundleCard = document.getElementById("bundleCard");

let activeVideo = null;

// -------------------- helpers --------------------
function validWA() {
  return /^\d{10}$/.test((waNumber.value || "").trim());
}

const bundleByCode = {};
(catalog.bundles || []).forEach(b => { bundleByCode[b.code] = b; });

function bundleLabel(b, lang) {
  if (!b) return "";
  const names = b.names || {};
  return (names[lang] || names["en"] || b.display_name || b.code || "").trim();
}

function bundleLabelByCode(code, lang) {
  return bundleLabel(bundleByCode[code], lang) || code;
}

function populateSelect(el, items, labelFn, includeAll=true) {
  el.innerHTML = "";
  if (includeAll) {
    const allOpt = document.createElement("option");
    allOpt.value = "";
    allOpt.textContent = "-- All --";
    el.appendChild(allOpt);
  }
  (items || []).forEach(i => {
    const o = document.createElement("option");
    o.value = i.code;
    o.textContent = (labelFn(i) || i.code || "").trim();
    el.appendChild(o);
  });
}

function repopulateBundleSelect(preserveValue=true) {
  const current = preserveValue ? bundleSel.value : "";
  populateSelect(bundleSel, catalog.bundles, b => bundleLabel(b, langSel.value));
  if (preserveValue && current) {
    bundleSel.value = current;
  }
}

populateSelect(therapySel, catalog.therapy_areas, t => t.display_name);
populateSelect(topicSel, catalog.topics, t => t.display_name);
repopulateBundleSelect(false);

function clearVideoSelection() {
  activeVideo = null;
}

function filteredVideos() {
  const q = (searchBox.value || "").toLowerCase().trim();
  const bundle = (bundleSel.value || "").trim();
  const therapy = (therapySel.value || "").trim();
  const topic = (topicSel.value || "").trim();

  return (catalog.videos || []).filter(v => {
    // Bundle selection should show ALL videos in that bundle (ignore therapy/topic)
    if (bundle) {
      if (!Array.isArray(v.bundle_codes) || !v.bundle_codes.includes(bundle)) return false;
    } else {
      if (therapy && (!Array.isArray(v.therapy_codes) || !v.therapy_codes.includes(therapy))) return false;
      if (topic && (!Array.isArray(v.topic_codes) || !v.topic_codes.includes(topic))) return false;
    }

    if (q && !(v.search_text || "").includes(q)) return false;
    return true;
  });
}

function renderVideos() {
  const lang = langSel.value;
  const vids = filteredVideos();

  // If the selected video is no longer in the filtered list, clear it
  if (activeVideo && !vids.some(v => v.id === activeVideo.id)) {
    activeVideo = null;
  }

  videoList.innerHTML = "";

  if (!vids.length) {
    videoList.style.display = 'none';
    emptyState.style.display = 'block';
    return;
  }

  videoList.style.display = 'block';
  emptyState.style.display = 'none';

  vids.forEach(v => {
    const d = document.createElement("div");
    d.className = "video-item" + (activeVideo && activeVideo.id === v.id ? " active" : "");
    
    const title = (v.titles && (v.titles[lang] || v.titles["en"])) || v.id;
    
    d.innerHTML = `
      <div class="video-icon">‚ñ∂Ô∏è</div>
      <div class="video-title">${escapeHtml(title)}</div>
      <div style="font-size: 0.75rem; color: var(--muted); white-space: nowrap;">
        ${(v.bundle_codes && v.bundle_codes.length) || 0} bundle(s)
      </div>
    `;

    d.onclick = () => {
      activeVideo = v;
      updateButtons();
      renderVideos();
    };
    videoList.appendChild(d);
  });
}

function updateContextHint() {
  const lang = langSel.value;
  const bundle = (bundleSel.value || "").trim();

  if (activeVideo) {
    const t = (activeVideo.titles && (activeVideo.titles[lang] || activeVideo.titles["en"])) || activeVideo.id;
    contextHint.textContent = `Selected video: ${t}`;
    return;
  }

  if (bundle) {
    const bName = bundleLabelByCode(bundle, lang) || bundle;
    const count = (catalog.videos || []).filter(v => Array.isArray(v.bundle_codes) && v.bundle_codes.includes(bundle)).length;
    contextHint.textContent = `Bundle selected: ${bName} (${count} video${count === 1 ? "" : "s"}).`;
    return;
  }

  contextHint.textContent = "Browse videos using filters above";
}

function updateButtons() {
  const waOk = validWA();
  const bundle = (bundleSel.value || "").trim();

  // Show exactly one action at a time:
  // - If a video is selected -> Share Video
  // - Else if a bundle is selected -> Share Bundle
  // - Else -> show none
  if (activeVideo) {
    videoCard.style.display = "block";
    bundleCard.style.display = "none";
    shareVideoBtn.disabled = !waOk;
  } else if (bundle) {
    videoCard.style.display = "none";
    bundleCard.style.display = "block";
    shareBundleBtn.disabled = !waOk;
  } else {
    videoCard.style.display = "none";
    bundleCard.style.display = "none";
  }

  updateContextHint();
}

function buildMessage(title, link, lang) {
  const prefix = (catalog.message_prefixes && catalog.message_prefixes[lang]) || "";
  const p = (prefix || "").trim();
  const t = (title || "").trim();
  let msg = "";
  if (p) msg += p + "\n\n";
  if (t) msg += t + "\n";
  msg += link;
  return msg;
}

function shareToWhatsApp(message) {
  const num = (waNumber.value || "").trim();
  if (!/^\d{10}$/.test(num)) return;
  window.open(`https://wa.me/91${num}?text=${encodeURIComponent(message)}`);
}

// Basic HTML escaping for injected content
function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

// -------------------- actions --------------------
shareVideoBtn.onclick = () => {
  if (!activeVideo) return;
  const lang = langSel.value;
  const title = (activeVideo.titles && (activeVideo.titles[lang] || activeVideo.titles["en"])) || activeVideo.id;
  const link = `${location.origin}/p/${catalog.doctor_id}/v/${activeVideo.id}/?lang=${lang}`;
  shareToWhatsApp(buildMessage(title, link, lang));
};

shareBundleBtn.onclick = () => {
  const bundle = (bundleSel.value || "").trim();
  if (!bundle) return;
  const lang = langSel.value;
  const title = bundleLabelByCode(bundle, lang) || bundle;
  const link = `${location.origin}/p/${catalog.doctor_id}/c/${bundle}/?lang=${lang}`;
  shareToWhatsApp(buildMessage(title, link, lang));
};

// -------------------- event wiring --------------------
therapySel.addEventListener("change", () => {
  // therapy/topic filtering is for the "browse" mode; clear bundle
  bundleSel.value = "";
  clearVideoSelection();
  renderVideos();
  updateButtons();
});

topicSel.addEventListener("change", () => {
  bundleSel.value = "";
  clearVideoSelection();
  renderVideos();
  updateButtons();
});

bundleSel.addEventListener("change", () => {
  // selecting a bundle means "show everything in this bundle"
  therapySel.value = "";
  topicSel.value = "";
  clearVideoSelection();
  renderVideos();
  updateButtons();
});

langSel.addEventListener("change", () => {
  // bundle names are localized, so repopulate bundle dropdown on language change
  repopulateBundleSelect(true);
  renderVideos();
  updateButtons();
});

searchBox.addEventListener("input", () => {
  clearVideoSelection();
  renderVideos();
  updateButtons();
});

waNumber.addEventListener("input", () => {
  updateButtons();
});

// Initial render
renderVideos();
updateButtons();
</script>
{% endblock %}
